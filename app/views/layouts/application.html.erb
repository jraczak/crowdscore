<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:svg="http://www.w3.org/2000/svg">
  <head>
    <title><%= "Crowdscore #{yield(:title)}" %></title>
    <%= stylesheet_link_tag "application" %>
    <%= csrf_meta_tags %>
    <%= javascript_include_tag "application" %>
    <%= yield :scripts %>
  </head>
  
  <!-- try to get the user's location to use around the site -->
  <% unless cookies[:detected_user_location] %>
    <script>
      getUserLocation();
    </script>
  <% end %>
  
  <script type="text/javascript">
      (function() {
       var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
       po.src = 'https://apis.google.com/js/client:plusone.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
     })();
  </script>
  
  <script type="text/javascript">
  function signinCallback(authResult) {
  if (authResult['access_token']) {
    // Successfully authorized
    // Hide the sign-in button now that the user is authorized, for example:
    document.getElementById('signinButton').setAttribute('style', 'display: none');
    alert("this worked!");
  } else if (authResult['error']) {
    // There was an error.
    // Possible error codes:
    //   "access_denied" - User denied access to your app
    //   "immediate_failed" - Could not automatically log in the user
    // console.log('There was an error: ' + authResult['error']);
  }
}
  </script>
  
  <!-- start Mixpanel -->
  <script type="text/javascript">(function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="//cdn.mxpnl.com/libs/mixpanel-2.2.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);
mixpanel.init("<% if Rails.env.development? %>0049809657a93a75fea2bee579959d0f<% elsif Rails.env.production? %>064776f76ea0c5bb065dd81b934405d8<% end %>");</script>
<!-- end Mixpanel -->

<script>
mixpanel.track_links("#register", "click-register", { "page": "<%= request.path %>" });
</script>

  <body>

    <div class="page-wrapper">    
      <div class="container">
        <%= render 'layouts/navbar' %>

        <div id="flash-container">  
          <% flash.each do |name, msg| %>
            <div class="<%= name %>">
              <p class="msg"><%= msg %></p>
            </div>
          <% end %>
        </div>

        <%= yield %>

        <div class="footer-push"></div>
  
      </div>
      <!-- Hide footer on search page -->
      <% unless params[:action] == 'search' %>
        <%= render "layouts/footer" %>
      <% end %>  
    </div>
  
    <div id="register-modal" class="modal">
      <div class="modal-mask">
        <div class="modal-content download-app">
          <div class="close-modal">+</div>
          <div class="modal-vertical-center">
            <div class="left-rail">
              <h1>Register</h1>
              <p>Fill out the quick info below and weâ€™ll set up your account. You can finish filling out your profile later. Already a member? <%= link_to "Sign in", "#", class: "button-show-login-modal" %></p>
              <%= link_to(user_omniauth_authorize_path(:facebook), class: "modal-facebook-signup-button") do %>
                <i class="icon-facebook"></i><div>REGISTER WITH FACEBOOK</div>
              <% end %>
            </div>
            <div class="right-rail">
              <%= form_for devise_resource, as: resource_name, url: registration_path(resource_name), html: { class: 'registration-modal-form' } do |f| %>
                <div class="registration-modal-form-field full">
                  <%= f.label :email, "email address", class: "" %>
                  <%= f.text_field :email, class: "", size: "30" %>
                </div>
                <div class="registration-modal-form-field half">
                  <%= f.label :first_name, class: "" %>
                  <%= f.text_field :first_name, size: "30", class: "" %>
                </div>
                <div class="registration-modal-form-field half">
                  <%= f.label :password, class: "" %>
                  <%= f.password_field :password, class: "", size: "30" %>
                </div>
                <div class="registration-modal-form-field half">
                  <%= f.label :username, "Choose your username" , class: "" %>
                  <%= f.text_field :username, class: "", size: "30", :disabled => f.object.persisted? %>
                </div>
                <div class="registration-modal-form-field half">
                  <%= f.label :password_confirmation, "confirm password", class: "" %>
                  <%= f.password_field :password_confirmation, class: "", size: "30" %>
                </div>
                <%= f.submit "CREATE YOUR ACCOUNT", class: "registration-modal-submit-button" %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div id="login-modal" class="modal">
      <div class="modal-mask">
        <div class="modal-content download-app">
          <div class="close-modal">+</div>
          <div class="modal-vertical-center">
            <div class="modal-centered-body">
              <h1>Sign in</h1>
              <%= link_to(user_omniauth_authorize_path(:facebook), class: "modal-facebook-signin-button") do %>
                <i class="icon-facebook"></i><div>SIGN IN WITH FACEBOOK</div>
              <% end %><br>
              <%= form_for devise_resource, as: resource_name, url: session_path(resource_name), html: { class: 'login-modal-form' } do |f| %>
                <div class="registration-modal-form-field">
                  <%= f.label :email, "email or username", class: "" %>
                  <%= f.text_field :email, class: "", tabindex: "1" %>
                  <p id="join-crowdscore-link"> Not a member yet? <%= link_to "Join Crowdscore", "#", class: "button-show-register-modal" %></p>
                </div>
                <div class="registration-modal-form-field password">
                  <%= f.label :password, class: "" %>
                  <%= f.password_field :password, tabindex: "2" %>
                  <%= f.hidden_field :page_action, value: "" %>
                  <p id="forgot-password-link"> Forgot your password? <%= link_to "Request a reset", new_user_password_path %></p>
                </div>
                <%= f.submit "Sign in", class: "registration-modal-submit-button", tabindex: "3" %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
// Include the UserVoice JavaScript SDK (only needed once on a page)
UserVoice=window.UserVoice||[];(function(){var uv=document.createElement('script');uv.type='text/javascript';uv.async=true;uv.src='//widget.uservoice.com/QKme0uQF5KF0iFN17AsfQ.js';var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(uv,s)})();

//
// UserVoice Javascript SDK developer documentation:
// https://www.uservoice.com/o/javascript-sdk
//

// Set colors
UserVoice.push(['set', {
  accent_color: '#02b8ea',
  trigger_color: 'white',
  trigger_background_color: '#02b8ea'
}]);

// Identify the user and pass traits
// To enable, replace sample data with actual user traits and uncomment the line
UserVoice.push(['identify', {
  
  <% if current_user %>
    email:      '<%= current_user.email %>', // User?s email address
  <% end %>
  <% if current_user %>
    name:       '<%= current_user.first_name %>', // User?s real name
  <% end %>
  //created_at: 1364406966, // Unix timestamp for the date the user signed up
  //id:         123, // Optional: Unique id of the user (if set, this should not change)
  //type:       'Owner', // Optional: segment your users by type
  //account: {
  //  id:           123, // Optional: associate multiple users with a single account
  //  name:         'Acme, Co.', // Account name
  //  created_at:   1364406966, // Unix timestamp for the date the account was created
  //  monthly_rate: 9.99, // Decimal; monthly rate of the account
  //  ltv:          1495.00, // Decimal; lifetime value of the account
  //  plan:         'Enhanced' // Plan name for the account
  //}
}]);

// Add default trigger to the bottom-right corner of the window:
UserVoice.push(['addTrigger', { mode: 'contact', trigger_position: 'bottom-right' }]);

// Or, use your own custom trigger:
//UserVoice.push(['addTrigger', '#id', { mode: 'contact' }]);

// Autoprompt for Satisfaction and SmartVote (only displayed under certain conditions)
UserVoice.push(['autoprompt', {}]);
</script>
    
    <!-- COMMENT OUT OLD USERVOICE WIDGET CODE
    
    <script>
      var uvOptions = {};
      (function() {
        var uv = document.createElement('script'); uv.type = 'text/javascript'; uv.async = true;
        uv.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'widget.uservoice.com/0MsUmqbikVAbKrdEYidA.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(uv, s);
          })();
    </script>
    
    -->
    
    <script>
      var locationActive = 0;
      var searchActive = 0;
      var scrollSearch = 0;

      // Represents the faded div at the end of the search input
      // When clicked, focus on the search field
      $('.search-input-fade').click(function(){
        $('.search-input').focus();
      });

      // On focus, trigger animation to place search bar in active state
      $('.search-input').focus(function() {
        $('a.brand').addClass('invisible');
        $('.search-input').addClass('search-input-active');
        if (!scrollSearch)
          searchActive = 1;
        if (!locationActive){
          $('.edit').click();  
        }
      });

      // Place the searchbar into its inactive state
      $('.close').click(function(){

        // variable animation time for placing location input into active state
        var timer = searchActive ? 250 : 125;
        if (searchActive == 3) timer = 0;
        
        // Remove classes to place searchbar into inactive state
        $('a.brand').removeClass('invisible');
        $('.search-input').removeClass('search-input-active');
        $('.location-input').fadeTo(timer, 0, function(){
          var $this = $(this);
          $this.removeClass('location-input-active');
          $this.removeClass('location-symbol-active');
          $this.stop(true, true).fadeTo(timer, 1);
          locationActive = 0;
          searchActive = 0;
        });

        // swap close and edit buttons
        $('.close').stop(true, true).fadeOut(500, function(){
        $('.edit').stop(true, true).fadeIn(500);
        });

      });

      // On location focus, transition into location input active state
      $('.location-input').focus(function(){
        $('.edit').click();
        locationActive = 1;
      });

      // Place the searchbar into its inactive state
      $('.edit').click(function(){

        // variable animation time for placing location input into active state
        var timer = searchActive ? 250 : 125;
        if (searchActive == 3) timer = 0;
        
        // Add classes to place searchbar into active state
        $('.location-input').fadeTo(timer, 0, function(){
          var $this = $(this);
          $this.addClass('location-input-active'); 
          $this.addClass('location-symbol-active');
          $this.stop(true, true).fadeTo(timer, 1);  
          locationActive = 1;
        });

        $('.edit').stop(true, true).fadeOut(timer, function(){
        $('.close').stop(true, true).fadeIn(timer);
        });

      });

      function slideDelay(){
        setTimeout(function(){
          if (!scrollSearch){
            $('.searchbar').addClass('search-bar-fixed-negpos');
            scrollSearch = 1; 
            $('.search-input').blur();
          }
        },50);
      }

      $(document).ready(function() {

        // Remove classes to place searchbar into inactive state  
        var s = $('div.searchbar'); 
        var pos = s.position();   

        // Handle search bar on scroll listener             
        $(window).scroll(function() {

            // Get the scroll distance from top of page
            var windowpos = $(window).scrollTop();

            // If the searchbar is no longer visible, handle the fixed scroll bar animation
            if (windowpos >= 120) {
              if (!scrollSearch){
                $('.searchbar-placeholder').addClass('searchbar-place-holder')
                $('.brand').addClass('brand-scroll').css('width', 0);

                $('.search-input').addClass('search-input-scroll');
                $('.search-input').focus();
                $('.searchbar').addClass('search-bar-top');
                slideDelay();
              }
            windowpos
            } else {
              if (windowpos <= 30){
                if (scrollSearch){
                  $('.searchbar-placeholder').removeClass('searchbar-place-holder')
                  $('.brand').css('width', '205px').removeClass('brand-scroll');
                  
                  $('.search-input').removeClass('search-input-scroll');
                  $('.close').click();
                  $('.searchbar').removeClass('search-bar-fixed-negpos'); 
                  $('.searchbar').removeClass('search-bar-top'); 
                  scrollSearch = 0;
                }
              }
            }
        });
      });

      $(document).ready(function() {
        $( "#login-button" ).click(function() {
          $( '#auth-modal' ).addClass("visible");
        });

        $('.close-modal').click(function(){
          $("#auth-modal").removeClass("visible");
        });
      });

      $(document).keyup(function(e) {
        if (e.keyCode == 27) { 
          $('.full-screen-modal').removeClass('visible');
        }
      });

      $('#submit-score-btn').click(function(){
        $( '#submit-score-modal' ).addClass("visible");
      });

      $('.close-modal').click(function(){
        $("#auth-modal").removeClass("visible");
      });


    </script>


  </body>
</html>
